#include <furi.h>
#include <gui/gui.h>
#include <notification/notification.h>
#include <notification/notification_messages.h>

#define SPEED 100
#define LOGO_W 32
#define LOGO_H 16

/* generated by fbt from .png files in images folder */
#include <dvd_screensaver_icons.h>

typedef struct {
    uint8_t x;
    uint8_t y;
} DrawContext;

static void draw_callback(Canvas* canvas, void* ctx) {
    furi_assert(ctx);
    DrawContext* draw_context = ctx;

    canvas_clear(canvas);
    canvas_draw_icon(canvas, draw_context->x, draw_context->y, &I_logo);
}

static void input_callback(InputEvent* input_event, void* ctx) {
    furi_assert(ctx);
    FuriMessageQueue* event_queue = ctx;

    furi_message_queue_put(event_queue, input_event, FuriWaitForever);
}

int32_t dvd_screensaver_app(void* p) {
    UNUSED(p);

    InputEvent event;
    FuriMessageQueue* event_queue = furi_message_queue_alloc(8, sizeof(InputEvent));

    DrawContext* draw_context = malloc(sizeof(DrawContext));

    draw_context->x = rand() % (126 - LOGO_W);
    draw_context->y = rand() % (62 - LOGO_H);

    int8_t flip_x = (rand() % 2) ? 1 : -1;
    int8_t flip_y = (rand() % 2) ? 1 : -1;

    ViewPort* view_port = view_port_alloc();
    view_port_draw_callback_set(view_port, draw_callback, draw_context);
    view_port_input_callback_set(view_port, input_callback, event_queue);

    Gui* gui = furi_record_open(RECORD_GUI);
    gui_add_view_port(gui, view_port, GuiLayerFullscreen);

    NotificationApp* notification = furi_record_open(RECORD_NOTIFICATION);
    notification_message_block(notification, &sequence_display_backlight_enforce_on);

    while(true) {
        if(furi_message_queue_get(event_queue, &event, SPEED) == FuriStatusOk &&
           event.key == InputKeyBack)
            break;

        draw_context->x += flip_x;
        draw_context->y += flip_y;

        if(draw_context->x == 0) flip_x = 1;
        if(draw_context->y == 0) flip_y = 1;
        if(draw_context->x + LOGO_W == 128) flip_x = -1;
        if(draw_context->y + LOGO_H == 64) flip_y = -1;

        view_port_update(view_port);
    };

    notification_message(notification, &sequence_display_backlight_enforce_auto);

    furi_message_queue_free(event_queue);

    gui_remove_view_port(gui, view_port);
    view_port_free(view_port);
    furi_record_close(RECORD_GUI);

    return 0;
}
